<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlliedWork â€” Allied Algorithms #58590</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:      #040c18;
  --bg2:     #070e1c;
  --bg3:     #0a1929;
  --bg4:     #0d1e36;
  --border:  #0e2240;
  --border2: #1e3a5f;
  --text:    #dce8ff;
  --text2:   #7888a0;
  --text3:   #344d68;
  --blue:    #3b9eff;
  --green:   #00c56e;
  --green2:  #00e882;
  --orange:  #ff9d3b;
  --red:     #ff3355;
  --sidebar: #060d1a;
  --mon-bg:  #070e1c;
  --run-glow:rgba(0,197,110,0.28);
  --sb-track:#040c18;
  --sb-thumb:#1e3a5f;
}
:root[data-theme="light"] {
  --bg:      #eef2fa;
  --bg2:     #ffffff;
  --bg3:     #e4ecf8;
  --bg4:     #d8e4f4;
  --border:  #c4d4ec;
  --border2: #9ab4d8;
  --text:    #0c1c34;
  --text2:   #3a5070;
  --text3:   #7890a8;
  --blue:    #1a6fd4;
  --green:   #007a44;
  --green2:  #009958;
  --orange:  #c55a00;
  --red:     #cc1133;
  --sidebar: #e4ecf8;
  --mon-bg:  #ffffff;
  --run-glow:rgba(0,122,68,0.22);
  --sb-track:#dce8f4;
  --sb-thumb:#9ab4d8;
}

/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background .18s, color .18s;
  -webkit-font-smoothing: antialiased;
}
canvas { display:block; }

/* â”€â”€â”€ SCROLLBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--sb-track); }
::-webkit-scrollbar-thumb { background:var(--sb-thumb); border-radius:2px; }

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input[type=range] {
  -webkit-appearance:none; appearance:none;
  height:3px; background:var(--border); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:12px; height:12px;
  border-radius:50%; background:var(--green); cursor:pointer;
}
input[type=number], select.aw-select {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--blue); font-family:'Space Mono',monospace;
  font-size:.67rem; padding:2px 6px; outline:none;
  border-radius:4px; transition:border-color .12s;
}
input[type=number]:focus, select.aw-select:focus { border-color:var(--green); }
select.aw-select { appearance:none; cursor:pointer; }

/* â”€â”€â”€ MONACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.monaco-editor .margin,
.monaco-editor,
.monaco-editor-background,
.monaco-editor .inputarea.ime-input { background:var(--mon-bg) !important; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 188px;
  flex-shrink: 0;
  overflow: hidden;
  transition: width .22s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed { width: 0; }

/* â”€â”€â”€ FILE ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-item {
  display:flex; align-items:center; gap:6px;
  padding:5px 8px; border-radius:6px; cursor:pointer;
  font-size:.57rem; color:var(--text2);
  border:1px solid transparent;
  transition: background .1s, border-color .1s;
}
.file-item:hover  { background:var(--bg3); }
.file-item.active { background:var(--bg4); border-color:var(--green); color:var(--green); }
.file-actions { display:none; gap:2px; margin-left:auto; }
.file-item:hover .file-actions,
.file-item.active .file-actions { display:flex; }
.file-actions button { color:var(--text3); transition:color .1s; line-height:1; }
.file-actions button:hover { color:var(--red); }

/* â”€â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-pill {
  width:32px; height:17px; border-radius:999px;
  background:var(--border2); position:relative; cursor:pointer;
  transition:background .18s; flex-shrink:0;
}
.toggle-pill::after {
  content:''; position:absolute; top:2px; left:2px;
  width:13px; height:13px; border-radius:50%;
  background:var(--green); transition:transform .18s;
}
[data-theme="light"] .toggle-pill::after { transform:translateX(15px); }

/* â”€â”€â”€ RUN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-run {
  background:var(--green); color:#fff; font-weight:700;
  font-family:'Space Mono',monospace; letter-spacing:.08em; text-transform:uppercase;
  border:none; border-radius:999px; cursor:pointer;
  box-shadow:0 0 12px var(--run-glow);
  transition:background .12s, box-shadow .12s, transform .08s;
}
.btn-run:hover  { background:var(--green2); box-shadow:0 0 18px var(--run-glow); }
.btn-run:active { transform:scale(.97); }

/* â”€â”€â”€ GHOST BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-ghost {
  background:transparent; font-family:'Space Mono',monospace;
  letter-spacing:.06em; text-transform:uppercase; cursor:pointer;
  border:1px solid var(--border2); border-radius:999px; color:var(--text2);
  transition:border-color .12s, color .12s;
}
.btn-ghost:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€â”€ CONFIG TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfg-input {
  font-family:'Space Mono',monospace; font-size:.62rem; line-height:1.55;
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--text); outline:none; resize:none; border-radius:5px;
  padding:5px 9px; width:100%;
  transition:border-color .12s;
}
#cfg-input:focus { border-color:var(--green); }
#cfg-input::placeholder { color:var(--text3); font-style:italic; }

/* â”€â”€â”€ CONSOLE LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cline {
  display:flex; gap:7px; align-items:baseline;
  font-size:.59rem; line-height:1.65; padding:1px 0;
  font-family:'Space Mono',monospace;
}
.cline-ts  { color:var(--text3); flex-shrink:0; font-size:.5rem; user-select:none; }
.cline-ic  { flex-shrink:0; width:10px; text-align:center; }
.c-ok   { color:var(--green); }
.c-err  { color:var(--red); }
.c-warn { color:var(--orange); }
.c-info { color:var(--blue); }
.c-py   { color:#8bcfb0; }
.c-sys  { color:var(--text3); }

/* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-tab {
  height:100%; padding:0 12px;
  font-size:.41rem; letter-spacing:2.5px; text-transform:uppercase;
  border-bottom:2px solid transparent; color:var(--text3);
  cursor:pointer; background:transparent; border-top:none; border-left:none; border-right:none;
  font-family:'Space Mono',monospace;
  transition:color .12s, border-color .12s;
}
.panel-tab.active { color:var(--green); border-color:var(--green); }
.panel-tab:hover:not(.active) { color:var(--text2); }

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec { font-size:.41rem; letter-spacing:3px; color:var(--text3); text-transform:uppercase; }

/* â”€â”€â”€ UNSAVED DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.blink { animation:blink 1.8s ease-in-out infinite; }

/* â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#err-badge { transition:color .15s; }

/* â”€â”€â”€ RESIZE HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resize-handle {
  width:3px; flex-shrink:0; cursor:col-resize;
  background:var(--border);
  transition:background .15s;
}
#resize-handle:hover { background:var(--green); }
</style>
</head>
<body class="flex flex-col" style="height:100vh">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="flex items-center gap-3 px-3 shrink-0 border-b z-10"
        style="height:44px;background:var(--bg2);border-color:var(--border)">

  <!-- Sidebar toggle -->
  <button id="sb-toggle" onclick="toggleSidebar()" title="Toggle sidebar (âŒ˜B)"
    class="w-7 h-7 flex items-center justify-center rounded"
    style="color:var(--text3);transition:color .12s"
    onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="9" y1="3" x2="9" y2="21"/>
    </svg>
  </button>

  <!-- Logo -->
  <div class="font-['Bebas_Neue'] text-xl tracking-widest leading-none select-none"
       style="text-shadow:0 0 14px var(--run-glow)">
    <span style="color:var(--text)">ALLIED</span><span style="color:var(--green)">WORK</span>
  </div>

  <!-- Active file pill -->
  <div class="flex items-center gap-1.5 px-2.5 py-1 rounded border text-[.55rem] tracking-widest"
       style="background:var(--bg3);border-color:var(--border2);color:var(--text2)">
    <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background:var(--green)"></span>
    <span id="active-tab-name" class="truncate max-w-[140px]">mission.aw</span>
    <span id="unsaved-dot" class="w-1.5 h-1.5 rounded-full blink hidden shrink-0"
          style="background:var(--orange)"></span>
  </div>

  <div class="flex-1"></div>

  <!-- Actions -->
  <div class="flex items-center gap-2">
    <span class="text-[.48rem] tracking-widest hidden lg:block" style="color:var(--text3)">âŒ˜â†µ Run</span>
    <button onclick="runScript()" class="btn-run flex items-center gap-1.5 text-[.53rem] px-4 py-1.5">
      <svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      Run
    </button>
    <button onclick="exportPython()" class="btn-ghost flex items-center gap-1.5 text-[.5rem] px-3 py-1.5">
      <svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export .py
    </button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flex flex-1 min-h-0">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside id="sidebar" class="flex flex-col border-r"
         style="background:var(--sidebar);border-color:var(--border)">
    <div class="flex flex-col flex-1 min-h-0" style="width:188px">

      <!-- Files -->
      <div class="flex items-center justify-between px-3 pt-3 pb-1 shrink-0">
        <span class="sec">Files</span>
        <button onclick="newFile()" title="New file"
          style="color:var(--text3);transition:color .12s"
          onmouseover="this.style.color='var(--green)'" onmouseout="this.style.color='var(--text3)'">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div id="file-list" class="overflow-y-auto px-2 pb-1 flex flex-col gap-0.5 shrink-0"
           style="max-height:200px"></div>

      <div class="mx-3 my-2 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Settings -->
      <div class="px-3 pb-1 shrink-0"><span class="sec">Settings</span></div>
      <div class="px-3 flex flex-col gap-2 pb-3 shrink-0">

        <!-- Theme -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span id="theme-icon" class="text-xs">ðŸŒ™</span>
            <span class="text-[.57rem]" style="color:var(--text2)">Dark Mode</span>
          </div>
          <div class="toggle-pill" onclick="toggleTheme()"></div>
        </div>

        <!-- Robot size -->
        <div>
          <span class="sec block mb-1">Robot Size (in)</span>
          <div class="flex items-center gap-1.5 text-[.53rem]" style="color:var(--text2)">
            W<input type="number" id="robot-w" value="12" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
            L<input type="number" id="robot-l" value="16" min="1" max="99"
                    style="width:36px;text-align:center" oninput="render()">
          </div>
        </div>

        <!-- Sim speed -->
        <div class="flex items-center justify-between">
          <span class="text-[.53rem]" style="color:var(--text2)">Sim Speed</span>
          <select id="sim-speed" class="aw-select text-[.53rem]">
            <option value="0.5">0.5Ã—</option>
            <option value="1" selected>1Ã—</option>
            <option value="2">2Ã—</option>
            <option value="4">4Ã—</option>
          </select>
        </div>
      </div>

      <div class="mx-3 my-1 shrink-0" style="height:1px;background:var(--border)"></div>

      <!-- Stats -->
      <div class="px-3 pt-1 pb-2 shrink-0">
        <span class="sec">Field</span>
        <div class="mt-1.5 flex flex-col gap-0.5 text-[.53rem]">
          <div class="flex justify-between">
            <span style="color:var(--text3)">Waypoints</span>
            <span id="stat-pts" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Distance</span>
            <span id="stat-dist" style="color:var(--green)">â€”</span>
          </div>
          <div class="flex justify-between">
            <span style="color:var(--text3)">Errors</span>
            <span id="stat-err" style="color:var(--green)">0</span>
          </div>
        </div>
      </div>

      <div class="flex-1"></div>

      <!-- Brand -->
      <div class="px-3 py-3 border-t shrink-0" style="border-color:var(--border)">
        <div class="font-['Bebas_Neue'] text-sm tracking-widest" style="color:var(--text3)">
          ALLIED<span style="color:var(--green)">ALGOS</span>
        </div>
        <div class="text-[.41rem] tracking-widest mt-0.5" style="color:var(--text3)">
          #58590 Â· alliedalgos.org
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN COLUMNS â”€â”€ -->
  <div class="flex flex-1 min-w-0 min-h-0">

    <!-- â”€â”€â”€ EDITOR COLUMN â”€â”€â”€ -->
    <div id="editor-col" class="flex flex-col min-h-0 border-r"
         style="width:45%;border-color:var(--border)">

      <!-- Editor toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3">
          <span class="sec">Editor</span>
          <span id="err-badge" class="text-[.5rem]" style="color:var(--green)">âœ“ Ready</span>
        </div>
        <span class="text-[.41rem] tracking-widest" style="color:var(--text3)">
          0Â° right Â· 90Â° up Â· 1 cell = 1 in
        </span>
      </div>

      <!-- Monaco -->
      <div id="monaco-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- â”€â”€â”€ RESIZE HANDLE â”€â”€â”€ -->
    <div id="resize-handle"></div>

    <!-- â”€â”€â”€ FIELD + CONSOLE COLUMN â”€â”€â”€ -->
    <div class="flex flex-col flex-1 min-w-0 min-h-0">

      <!-- Field toolbar -->
      <div class="flex items-center justify-between px-3 border-b shrink-0"
           style="height:30px;background:var(--bg2);border-color:var(--border)">
        <div class="flex items-center gap-3 min-w-0">
          <span class="sec shrink-0">AlliedPath Field</span>
          <span id="field-stats" class="text-[.47rem] truncate" style="color:var(--text3)">
            Code drives the path
          </span>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Scrub slider -->
          <input type="range" id="scrub" min="0" max="1000" value="0"
                 style="width:80px" oninput="onScrub(this.value)">
          <span id="scrub-label" class="text-[.47rem] w-6 shrink-0" style="color:var(--text3)">0%</span>
          <span style="color:var(--text3);font-size:.47rem;margin-left:4px">HDG</span>
          <span id="hdg" class="text-[.47rem]" style="color:var(--green)">â€”</span>
          <span style="color:var(--text3);font-size:.47rem">POS</span>
          <span id="pos" class="text-[.47rem]" style="color:var(--green)">â€”</span>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="overflow-auto flex-1 min-h-0" style="background:var(--bg)">
        <div class="inline-flex flex-col items-start p-2">
          <div class="flex">
            <canvas id="yaxis"></canvas>
            <canvas id="field"></canvas>
          </div>
          <canvas id="xaxis"></canvas>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€ CONSOLE PANEL (under map) â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="shrink-0 border-t flex flex-col" style="height:200px;border-color:var(--border)">

        <!-- Tab bar -->
        <div class="flex items-center border-b shrink-0"
             style="height:28px;background:var(--bg2);border-color:var(--border)">
          <button class="panel-tab active" id="tab-problems"
                  onclick="switchTab('problems')">Problems</button>
          <button class="panel-tab" id="tab-console"
                  onclick="switchTab('console')">Console</button>
          <button class="panel-tab" id="tab-python"
                  onclick="switchTab('python')">Python</button>
          <div class="flex-1"></div>
          <span id="prob-count" class="text-[.43rem] px-2" style="color:var(--text3)">0 issues</span>
          <button onclick="copyPython()" id="copy-btn"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-1.5 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Copy</button>
          <button onclick="clearConsole()"
            class="text-[.43rem] border px-2 py-0.5 rounded mr-2 transition-all"
            style="color:var(--text3);border-color:var(--border2);font-family:'Space Mono',monospace">Clear</button>
        </div>

        <!-- Robot config bar (always visible) -->
        <div class="flex items-center gap-3 px-3 py-1.5 border-b shrink-0"
             style="background:var(--bg3);border-color:var(--border)">
          <span class="sec shrink-0">Config</span>
          <textarea id="cfg-input" rows="1"
            placeholder="motors:A,B  wheel:56  track:112"
            spellcheck="false"
            style="flex:1;height:26px;padding-top:4px;padding-bottom:4px">motors:A,B  wheel:56  track:112</textarea>
          <button onclick="applyConfig()" class="btn-run text-[.47rem] px-3 py-1 shrink-0"
                  style="border-radius:5px">Apply</button>
        </div>

        <!-- Panel bodies -->
        <div id="panel-problems"
             class="flex-1 overflow-y-auto px-2 py-1.5 flex flex-col gap-0.5">
          <div class="cline">
            <span class="cline-ic c-info">â€º</span>
            <span class="c-info">Write missions and press Run.</span>
          </div>
        </div>

        <div id="panel-console"
             class="flex-1 overflow-y-auto px-2 py-1.5 hidden"
             style="background:var(--bg2)"></div>

        <div id="panel-python"
             class="flex-1 overflow-y-auto px-3 py-1.5 text-[.61rem] leading-relaxed whitespace-pre hidden"
             style="background:var(--bg2);font-family:'Space Mono',monospace">
          <span style="color:#4a6a8a;font-style:italic"># Press Run to generate SPIKE Prime Python</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="flex items-center justify-between px-4 shrink-0 text-[.41rem] tracking-widest uppercase select-none"
        style="height:20px;background:var(--green);color:rgba(0,0,0,0.6)">
  <div class="flex gap-5">
    <span>Allied Algorithms #58590</span>
    <span>alliedalgos.org</span>
  </div>
  <div class="flex gap-5">
    <span id="cursor-pos">Ln 1, Col 1</span>
    <span>SPIKE Prime Â· runloop</span>
    <span>AlliedWork</span>
  </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLIEDWORK â€” Allied Algorithms #58590
//  Production build
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 93, ROWS = 45;
const BG_URL = 'https://static.wixstatic.com/media/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png/v1/fill/w_888,h_508,al_c/41532e_7822743521f7432aae59f69bd7fa9444~mv2.png';
const FN = ['move','turn','speed','wait'];
const LS = { files:'aw_files', active:'aw_active', theme:'aw_theme', cfg:'aw_cfg', sb:'aw_sidebar' };

const DEFAULT = `# AlliedWork â€” Allied Algorithms #58590
# Code draws the path. 0Â°=right  90Â°=up  -90Â°=down

mission "launch"
  speed(80)
  move(24)
  turn(90)
  move(18)
  turn(-45)
  move(10)
  wait(0.5)
end

mission "return"
  speed(60)
  move(-10)
  turn(45)
  move(-18)
  turn(-90)
  move(-24)
end`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let files = {}, activeId = null, monacoEditor = null, skipSave = false;
let isDark = true, sidebarOpen = true;
let cfg = { motorL:'A', motorR:'B', diameter:56, track:112 };
let pts = [], progress = 0, animId = null, animLast = null;
let CELL = 10;

// â”€â”€ Canvas DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cvs  = document.getElementById('field');
const cvsy = document.getElementById('yaxis');
const cvsx = document.getElementById('xaxis');
const cx   = cvs.getContext('2d');
const cxy  = cvsy.getContext('2d');
const cxx  = cvsx.getContext('2d');
const scrub      = document.getElementById('scrub');
const scrubLabel = document.getElementById('scrub-label');

// Field background image
const BG = new Image();
BG.crossOrigin = 'anonymous';
BG.src = BG_URL;
BG.onload = render;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  try { localStorage.setItem(LS.sb, sidebarOpen ? '1' : '0'); } catch {}
  setTimeout(() => { monacoEditor?.layout(); recalcField(); }, 240);
}

function initSidebar() {
  try {
    if (localStorage.getItem(LS.sb) === '0') {
      sidebarOpen = false;
      document.getElementById('sidebar').classList.add('collapsed');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  try { isDark = localStorage.getItem(LS.theme) !== 'light'; } catch {}
  applyTheme();
}

function toggleTheme() {
  isDark = !isDark;
  try { localStorage.setItem(LS.theme, isDark ? 'dark' : 'light'); } catch {}
  applyTheme();
  if (monacoEditor) monaco.editor.setTheme(isDark ? 'aw-dark' : 'aw-light');
  render();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-icon').textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFiles() {
  try {
    const s = localStorage.getItem(LS.files);
    if (s) files = JSON.parse(s);
  } catch {}
  if (!Object.keys(files).length) {
    const id = 'f_' + Date.now();
    files[id] = { id, name:'mission.aw', content:DEFAULT, ts:Date.now() };
    saveFiles();
  }
}

function saveFiles() {
  try { localStorage.setItem(LS.files, JSON.stringify(files)); } catch {}
}

function setActive(id) {
  if (!files[id]) return;
  if (activeId && monacoEditor && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    saveFiles();
  }
  activeId = id;
  try { localStorage.setItem(LS.active, id); } catch {}
  if (monacoEditor) {
    skipSave = true;
    monacoEditor.setValue(files[id].content || '');
    skipSave = false;
    setTimeout(() => monacoEditor.focus(), 30);
  }
  document.getElementById('active-tab-name').textContent = files[id].name;
  document.getElementById('unsaved-dot').classList.add('hidden');
  renderFileList();
}

function newFile() {
  const raw = prompt('File name:', 'mission' + (Object.keys(files).length + 1) + '.aw');
  if (!raw) return;
  const name = raw.endsWith('.aw') ? raw : raw + '.aw';
  const id = 'f_' + Date.now();
  files[id] = { id, name, content:'# New file\n\nmission "run1"\n  move(12)\nend\n', ts:Date.now() };
  saveFiles();
  setActive(id);
}

function deleteFile(id) {
  if (Object.keys(files).length <= 1) { alert('Cannot delete the only file.'); return; }
  if (!confirm(`Delete "${files[id].name}"?`)) return;
  delete files[id];
  saveFiles();
  setActive(Object.keys(files)[0]);
}

function renameFile(id) {
  const raw = prompt('Rename:', files[id]?.name || '');
  if (!raw || raw === files[id].name) return;
  files[id].name = raw.endsWith('.aw') ? raw : raw + '.aw';
  saveFiles();
  if (id === activeId) document.getElementById('active-tab-name').textContent = files[id].name;
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  list.innerHTML = '';
  Object.values(files)
    .sort((a, b) => a.ts - b.ts)
    .forEach(f => {
      const el = document.createElement('div');
      el.className = 'file-item' + (f.id === activeId ? ' active' : '');

      const icon = document.createElement('span');
      icon.textContent = 'â—ˆ';
      icon.style.cssText = `color:${f.id===activeId?'var(--green)':'var(--text3)'};font-size:.6rem;flex-shrink:0`;

      const nm = document.createElement('span');
      nm.textContent = f.name;
      nm.title = f.name;
      nm.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';

      const acts = document.createElement('div');
      acts.className = 'file-actions';

      const ren = document.createElement('button');
      ren.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4z"/></svg>';
      ren.title = 'Rename';
      ren.onclick = e => { e.stopPropagation(); renameFile(f.id); };

      const del = document.createElement('button');
      del.innerHTML = '<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>';
      del.title = 'Delete';
      del.style.color = 'var(--text3)';
      del.onmouseover = () => del.style.color = 'var(--red)';
      del.onmouseout  = () => del.style.color = 'var(--text3)';
      del.onclick = e => { e.stopPropagation(); deleteFile(f.id); };

      acts.append(ren, del);
      el.append(icon, nm, acts);
      el.onclick = () => setActive(f.id);
      list.appendChild(el);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSOLE / TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = ['problems','console','python'];

function switchTab(t) {
  TABS.forEach(n => {
    document.getElementById('tab-' + n).classList.toggle('active', n === t);
    const p = document.getElementById('panel-' + n);
    if (p) p.classList.toggle('hidden', n !== t);
  });
}

function log(type, msg) {
  const panel = document.getElementById('panel-console');
  const row = document.createElement('div');
  row.className = 'cline';
  const ts = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const icons = { ok:'âœ“', err:'âœ•', warn:'âš ', info:'â€º', py:'Â»', sys:'Â·' };
  const cls   = { ok:'c-ok', err:'c-err', warn:'c-warn', info:'c-info', py:'c-py', sys:'c-sys' };
  row.innerHTML = `<span class="cline-ts">${ts}</span><span class="cline-ic ${cls[type]||'c-info'}">${icons[type]||'â€º'}</span><span class="${cls[type]||'c-info'}">${msg}</span>`;
  panel.appendChild(row);
  panel.scrollTop = panel.scrollHeight;
}

function clearConsole() {
  document.getElementById('panel-console').innerHTML = '';
  log('sys', 'Console cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCfg() {
  try {
    const s = localStorage.getItem(LS.cfg);
    if (s) cfg = Object.assign(cfg, JSON.parse(s));
  } catch {}
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
}

function parseCfg(raw) {
  const errs = [];
  const m = raw.match(/motors?\s*:\s*([a-fA-F])\s*[,\s]\s*([a-fA-F])/i);
  if (m) { cfg.motorL = m[1].toUpperCase(); cfg.motorR = m[2].toUpperCase(); }
  else errs.push('motors: use format "motors:A,B"');
  const w = raw.match(/wheel\s*:\s*(\d+\.?\d*)/i);
  if (w) cfg.diameter = parseFloat(w[1]);
  else errs.push('wheel: use format "wheel:56"');
  const t = raw.match(/track\s*:\s*(\d+\.?\d*)/i);
  if (t) cfg.track = parseFloat(t[1]);
  return errs;
}

function applyConfig() {
  const errs = parseCfg(document.getElementById('cfg-input').value);
  // Normalise textarea
  document.getElementById('cfg-input').value =
    `motors:${cfg.motorL},${cfg.motorR}  wheel:${cfg.diameter}  track:${cfg.track}`;
  try { localStorage.setItem(LS.cfg, JSON.stringify(cfg)); } catch {}
  if (errs.length) errs.forEach(e => log('warn', e));
  else log('ok', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
  runScript();
}

document.getElementById('cfg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); applyConfig(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIELD ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cellPx() {
  const sbW = sidebarOpen ? 188 : 0;
  const edW = document.getElementById('editor-col').offsetWidth;
  const avW = window.innerWidth - sbW - edW - 8;
  const avH = window.innerHeight - 44 - 20 - 30 - 200 - 30; // minus topbar/status/toolbars/console/scrub
  return Math.max(4, Math.min(13, Math.floor(avW / (COLS + 2)), Math.floor(avH / (ROWS + 2))));
}

function gap()  { return CELL >= 8 ? 1 : 0; }

function setupCanvases() {
  const g = gap(), YW = CELL <= 6 ? 18 : 28;
  const W = COLS * CELL + (COLS - 1) * g + 2;
  const H = ROWS * CELL + (ROWS - 1) * g + 2;
  cvs.width  = W; cvs.height  = H;
  cvsy.width = YW; cvsy.height = H;
  cvsx.width = YW + W; cvsx.height = 16;
  cvs._yw = YW;
}

function recalcField() {
  CELL = cellPx();
  setupCanvases();
  render();
}

function cc(x, y) {
  const g = gap();
  return { px: x * (CELL + g) + CELL / 2 + 1, py: ((ROWS - 1) - y) * (CELL + g) + CELL / 2 + 1 };
}

function dist(a, b)  { return Math.hypot(b.x - a.x, b.y - a.y); }
function angle(a, b) { return Math.atan2(-(b.y - a.y), b.x - a.x); }
function hdeg(a, b)  { return (((Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI) % 360) + 360) % 360; }

function turnAt(i) {
  if (i <= 0 || i >= pts.length - 1) return null;
  const a = pts[i-1], b = pts[i], c = pts[i+1];
  let d = (Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(b.y-a.y, b.x-a.x)) * 180 / Math.PI;
  while (d >  180) d -= 360;
  while (d < -180) d += 360;
  return d;
}

function totalLen() {
  let l = 0;
  for (let i = 1; i < pts.length; i++) l += dist(pts[i-1], pts[i]);
  return l;
}

function posAtT(t) {
  if (pts.length < 2) return null;
  const L = totalLen(); if (!L) return null;
  let acc = 0, tgt = t * L;
  for (let i = 1; i < pts.length; i++) {
    const sl = dist(pts[i-1], pts[i]);
    if (acc + sl >= tgt || i === pts.length - 1) {
      const f = sl > 0 ? (tgt - acc) / sl : 0;
      return {
        x: pts[i-1].x + (pts[i].x - pts[i-1].x) * f,
        y: pts[i-1].y + (pts[i].y - pts[i-1].y) * f,
        ang: angle(pts[i-1], pts[i]),
        hd:  hdeg(pts[i-1], pts[i])
      };
    }
    acc += sl;
  }
  return null;
}

function render() {
  drawField();
  drawAxes();
}

function drawField() {
  const g = gap();
  cx.clearRect(0, 0, cvs.width, cvs.height);

  // Background
  if (BG.complete && BG.naturalWidth > 0) {
    cx.drawImage(BG, 0, 0, cvs.width, cvs.height);
  } else {
    cx.fillStyle = isDark ? '#060d1a' : '#e8f0f8';
    cx.fillRect(0, 0, cvs.width, cvs.height);
  }

  // Grid lines
  cx.strokeStyle = 'rgba(59,158,255,0.07)'; cx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    const x = c * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(x, 0); cx.lineTo(x, cvs.height); cx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    const y = r * (CELL + g) + 1;
    cx.beginPath(); cx.moveTo(0, y); cx.lineTo(cvs.width, y); cx.stroke();
  }

  // Origin axes
  cx.strokeStyle = 'rgba(59,158,255,0.2)'; cx.lineWidth = 1;
  cx.beginPath(); cx.moveTo(1, 0); cx.lineTo(1, cvs.height); cx.stroke();
  const oy = (ROWS - 1) * (CELL + g) + 1;
  cx.beginPath(); cx.moveTo(0, oy); cx.lineTo(cvs.width, oy); cx.stroke();

  if (pts.length < 2) return;

  // Path segments
  for (let i = 1; i < pts.length; i++) {
    const { px:x1, py:y1 } = cc(pts[i-1].x, pts[i-1].y);
    const { px:x2, py:y2 } = cc(pts[i].x,   pts[i].y);
    const d = dist(pts[i-1], pts[i]);

    cx.beginPath();
    cx.strokeStyle = '#00c56e';
    cx.lineWidth   = Math.max(1.5, CELL * 0.18);
    cx.lineJoin = cx.lineCap = 'round';
    cx.shadowColor = 'rgba(0,197,110,0.3)'; cx.shadowBlur = 6;
    cx.moveTo(x1, y1); cx.lineTo(x2, y2); cx.stroke();
    cx.shadowBlur = 0;

    // Distance label
    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const lbl = d.toFixed(1) + '"', fs = Math.max(7, CELL * 0.68);
    cx.save(); cx.translate(mx, my);
    let rot = ang; if (rot > Math.PI / 2 || rot < -Math.PI / 2) rot += Math.PI;
    cx.rotate(rot);
    cx.font = `bold ${fs}px 'Space Mono',monospace`;
    const tw = cx.measureText(lbl).width, pd = 3;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
    cx.beginPath(); cx.roundRect(-(tw/2+pd), -(fs/2+pd), tw+pd*2, fs+pd*2, 3); cx.fill();
    cx.fillStyle = '#00e882'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(lbl, 0, 0); cx.restore();
  }

  // Waypoints + heading arrows + turn labels
  pts.forEach((p, i) => {
    const { px, py } = cc(p.x, p.y);
    const fs = Math.max(6, CELL * 0.54);

    // Waypoint square
    cx.fillStyle = '#00c56e';
    cx.shadowColor = 'rgba(0,197,110,0.6)'; cx.shadowBlur = 5;
    cx.fillRect(px - CELL/2, py - CELL/2, CELL, CELL); cx.shadowBlur = 0;
    if (CELL >= 7) {
      cx.fillStyle = '#fff';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center'; cx.textBaseline = 'middle';
      cx.fillText(i + 1, px, py);
    }

    // Heading arrow
    const hd = p.heading ?? 90, hr = hd * Math.PI / 180;
    const al = Math.max(CELL * 1.6, 10);
    const ax = px + Math.cos(hr) * al, ay = py - Math.sin(hr) * al;
    cx.save();
    cx.strokeStyle = '#ffe066'; cx.lineWidth = Math.max(1, CELL * 0.13);
    cx.shadowColor = 'rgba(255,224,100,.35)'; cx.shadowBlur = 4;
    cx.beginPath(); cx.moveTo(px, py); cx.lineTo(ax, ay); cx.stroke();
    const aw = Math.max(3, CELL * 0.32), aa = Math.atan2(ay - py, ax - px);
    cx.fillStyle = '#ffe066'; cx.shadowBlur = 0;
    cx.beginPath();
    cx.moveTo(ax, ay);
    cx.lineTo(ax - aw*Math.cos(aa-.4), ay - aw*Math.sin(aa-.4));
    cx.lineTo(ax - aw*Math.cos(aa+.4), ay - aw*Math.sin(aa+.4));
    cx.closePath(); cx.fill();
    // Heading label
    const lfs = Math.max(6, CELL * 0.55), htxt = Math.round(hd) + 'Â°';
    const lox = Math.cos(hr) * (al + lfs * .4), loy = -Math.sin(hr) * (al + lfs * .4);
    cx.font = `bold ${lfs}px 'Space Mono',monospace`;
    const htw = cx.measureText(htxt).width, hp = 2;
    cx.fillStyle = isDark ? 'rgba(4,12,24,.8)' : 'rgba(238,242,250,.9)';
    cx.beginPath(); cx.roundRect(px+lox-htw/2-hp, py+loy-lfs/2-hp, htw+hp*2, lfs+hp*2, 2); cx.fill();
    cx.fillStyle = '#ffe066'; cx.textAlign = 'center'; cx.textBaseline = 'middle';
    cx.fillText(htxt, px + lox, py + loy); cx.restore();

    // Turn angle label
    const ta = turnAt(i);
    if (ta !== null) {
      const tl = (ta >= 0 ? '+' : '') + ta.toFixed(1) + 'Â°';
      const tfs = Math.max(7, CELL * 0.66);
      const lx = px + CELL * 1.1, ly = py - CELL * 1.1;
      cx.font = `bold ${tfs}px 'Space Mono',monospace`;
      const ttw = cx.measureText(tl).width, tp = 3;
      cx.fillStyle = isDark ? 'rgba(4,12,24,.86)' : 'rgba(238,242,250,.92)';
      cx.beginPath(); cx.roundRect(lx-tp, ly-tfs/2-tp, ttw+tp*2, tfs+tp*2, 3); cx.fill();
      cx.fillStyle = ta >= 0 ? '#00e882' : '#ffaa33';
      cx.textAlign = 'left'; cx.textBaseline = 'middle';
      cx.fillText(tl, lx, ly);
    }
  });

  // Animated robot
  const p = posAtT(progress);
  if (p) {
    const { px, py } = cc(p.x, p.y);
    const rw = (parseFloat(document.getElementById('robot-w').value) || 12) * CELL;
    const rl = (parseFloat(document.getElementById('robot-l').value) || 16) * CELL;
    cx.save(); cx.translate(px, py); cx.rotate(p.ang);
    cx.shadowColor = 'rgba(0,232,130,.3)'; cx.shadowBlur = 10;
    cx.fillStyle   = 'rgba(0,197,110,.1)'; cx.fillRect(-rl/2, -rw/2, rl, rw);
    cx.strokeStyle = '#00e882'; cx.lineWidth = Math.max(1, CELL * .14); cx.strokeRect(-rl/2, -rw/2, rl, rw);
    cx.shadowBlur = 0; cx.fillStyle = '#00e882';
    cx.beginPath(); cx.arc(0, 0, Math.max(2, CELL * .26), 0, Math.PI * 2); cx.fill();
    const aw2 = Math.max(4, CELL * .42);
    cx.beginPath();
    cx.moveTo(rl/2, 0);
    cx.lineTo(rl/2 - aw2, -aw2 * .6);
    cx.lineTo(rl/2 - aw2,  aw2 * .6);
    cx.closePath(); cx.fill(); cx.restore();
    document.getElementById('hdg').textContent = p.hd.toFixed(1) + 'Â°';
    document.getElementById('pos').textContent = `(${p.x.toFixed(1)}", ${p.y.toFixed(1)}")`;
  }
}

function drawAxes() {
  const g = gap(), YW = cvs._yw || 28, fs = Math.max(5, CELL * .44);
  const col = isDark ? '#3a5a7a' : '#4a6a88';

  cxy.clearRect(0, 0, cvsy.width, cvsy.height);
  cxy.fillStyle = col; cxy.font = `${fs}px 'Space Mono',monospace`;
  cxy.textAlign = 'right'; cxy.textBaseline = 'middle';
  for (let y = 0; y < ROWS; y++) {
    if (y % 5 === 0) cxy.fillText(y + '"', YW - 2, ((ROWS-1) - y) * (CELL + g) + CELL/2 + 1);
  }

  cxx.clearRect(0, 0, cvsx.width, cvsx.height);
  cxx.fillStyle = col; cxx.font = `${fs}px 'Space Mono',monospace`;
  cxx.textAlign = 'center'; cxx.textBaseline = 'top';
  for (let x = 0; x < COLS; x++) {
    if (x % 5 === 0) cxx.fillText(x + '"', YW + x * (CELL + g) + CELL/2 + 1, 2);
  }
}

// Scrub slider
function onScrub(v) {
  progress = v / 1000;
  scrubLabel.textContent = Math.round(progress * 100) + '%';
  render();
}

// Auto-animate on Run (single pass)
function animateOnce() {
  cancelAnimationFrame(animId);
  progress = 0; scrub.value = 0; scrubLabel.textContent = '0%';
  if (pts.length < 2) return;
  animLast = null;
  const step = ts => {
    if (!animLast) animLast = ts;
    const dt  = (ts - animLast) / 1000; animLast = ts;
    const spd = parseFloat(document.getElementById('sim-speed').value);
    const L   = totalLen();
    progress += dt / (L > 0 ? L / (12 * spd) : 5);
    if (progress >= 1) {
      progress = 1; scrub.value = 1000; scrubLabel.textContent = '100%';
      render(); return;
    }
    scrub.value = Math.round(progress * 1000);
    scrubLabel.textContent = Math.round(progress * 100) + '%';
    render();
    animId = requestAnimationFrame(step);
  };
  animId = requestAnimationFrame(step);
}

window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(recalcField, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parse(src) {
  const lines = src.split('\n'), errors = [], ast = { missions:[], loose:[] };
  let mStk = [], rStk = [];
  const cur = () =>
    rStk.length ? rStk[rStk.length-1].body :
    mStk.length ? mStk[mStk.length-1].body : ast.loose;

  lines.forEach((raw, li) => {
    const ln = li + 1, s = raw.replace(/#.*$/, '').trim();
    if (!s) return;

    // mission "name"
    const mm = s.match(/^mission\s+"([^"]*)"$/i);
    if (mm) {
      if (mStk.length) errors.push({ ln, c:1, ec:raw.length+1, msg:'Cannot nest missions.', sev:'error' });
      const m = { type:'mission', name:mm[1], body:[], ln };
      ast.missions.push(m); mStk.push(m); return;
    }

    // repeat N times
    const rm = s.match(/^repeat\s+(\d+(?:\.\d+)?)\s+times$/i);
    if (rm) { rStk.push({ type:'repeat', count:Math.max(1, parseInt(rm[1])), body:[], ln }); return; }

    // end
    if (/^end$/i.test(s)) {
      if (rStk.length)      { cur().push(rStk.pop()); }
      else if (mStk.length) { mStk.pop(); }
      else errors.push({ ln, c:1, ec:4, msg:'Unexpected "end" â€” no open block.', sev:'error' });
      return;
    }

    // fn(arg)
    const fm = s.match(/^([a-zA-Z_]\w*)\s*\(([^)]*)\)$/);
    if (fm) {
      const name = fm[1].toLowerCase(), rawArg = fm[2].trim(), c = raw.search(/\S/) + 1;
      if (!FN.includes(name)) {
        errors.push({ ln, c, ec:c+fm[1].length, msg:`Unknown function "${name}". Try: ${FN.join(', ')}.`, sev:'error' }); return;
      }
      if (!rawArg) {
        errors.push({ ln, c, ec:raw.length+1, msg:`${name}() requires 1 argument.`, sev:'error' }); return;
      }
      const val = parseFloat(rawArg);
      if (isNaN(val)) {
        errors.push({ ln, c, ec:raw.length+1, msg:`Expected a number, got "${rawArg}".`, sev:'error' }); return;
      }
      if (name === 'speed' && (val < 1 || val > 100))
        errors.push({ ln, c, ec:raw.length+1, msg:`speed() should be 1â€“100, got ${val}.`, sev:'warning' });
      cur().push({ type:'call', name, val, ln }); return;
    }

    // bare fn name (forgot parens)
    const bm = s.match(/^([a-zA-Z_]\w*)$/);
    if (bm && FN.includes(bm[1].toLowerCase())) {
      const c = raw.search(/\S/) + 1;
      errors.push({ ln, c, ec:c+bm[1].length, msg:`Did you mean ${bm[1]}(value)?`, sev:'error' }); return;
    }

    errors.push({ ln, c:raw.search(/\S/)+1, ec:raw.length+1, msg:`Syntax error: "${s.slice(0,32)}${s.length>32?'â€¦':''}"`, sev:'error' });
  });

  mStk.forEach(m => errors.push({ ln:m.ln, c:1, ec:10, msg:`Mission "${m.name}" is never closed with "end".`, sev:'error' }));
  return { ast, errors };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE â†’ FIELD POINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toPoints(ast) {
  const out = [{ x:0, y:0, heading:90 }];
  let x = 0, y = 0, hd = 90;
  const exec = nodes => nodes.forEach(n => {
    if (n.type === 'call') {
      if (n.name === 'move') {
        const r = hd * Math.PI / 180;
        x = Math.min(Math.max(x + n.val * Math.cos(r), 0), COLS - 1);
        y = Math.min(Math.max(y + n.val * Math.sin(r), 0), ROWS - 1);
        out.push({ x: Math.round(x*10)/10, y: Math.round(y*10)/10, heading: hd });
      } else if (n.name === 'turn') {
        hd = ((hd + n.val) % 360 + 360) % 360;
        if (out.length) out[out.length - 1].heading = hd;
      }
    } else if (n.type === 'mission') {
      exec(n.body);
    } else if (n.type === 'repeat') {
      for (let i = 0; i < Math.min(n.count, 200); i++) exec(n.body);
    }
  });
  exec(ast.missions.length ? ast.missions : ast.loose);
  return out.filter((p, i) => i === 0 || p.x !== out[i-1].x || p.y !== out[i-1].y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PYTHON CODEGEN â€” SPIKE Prime runloop / motor_pair
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBody(nodes, indent, st) {
  const pad = '    '.repeat(indent), out = [];
  nodes.forEach(n => {
    if (n.type === 'call') {
      switch (n.name) {
        case 'move':
          out.push(`${pad}await drive(${n.val})  # ${n.val > 0 ? 'forward' : 'backward'} ${Math.abs(n.val)} in`);
          break;
        case 'turn':
          out.push(`${pad}await turn(${n.val})  # ${n.val > 0 ? 'left' : 'right'} ${Math.abs(n.val)}Â°`);
          break;
        case 'speed':
          out.push(`${pad}speed(${n.val})  # ${n.val}%`);
          st.spd = n.val; break;
        case 'wait':
          out.push(`${pad}wait(${Math.round(n.val * 1000)})  # ${n.val}s`);
          break;
      }
    } else if (n.type === 'repeat') {
      out.push(`${pad}for _ in range(${n.count}):`);
      const inner = genBody(n.body, indent + 1, st);
      out.push(...(inner.length ? inner : [`${pad}    pass`]));
    }
  });
  return out;
}

function genPython(ast) {
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '');
  const { motorL:mL, motorR:mR, diameter, track } = cfg;
  const r = (diameter / 2).toFixed(1);

  const body = [];
  ast.missions.forEach(m => {
    const st = { spd:50 };
    const lines = genBody(m.body, 1, st);
    body.push(`    # â”€â”€ ${m.name} ` + 'â”€'.repeat(Math.max(0, 40 - m.name.length)));
    body.push(...(lines.length ? lines : ['    pass']));
    body.push('');
  });
  const st2 = { spd:50 };
  body.push(...genBody(ast.loose, 1, st2));
  const hasCode = body.some(l => l.trim() && !l.trim().startsWith('#'));
  if (!hasCode) body.push('    pass');

  return `# ${'â•'.repeat(50)}
# AlliedWork â€” ${name}
# Allied Algorithms #58590 Â· alliedalgos.org
# Target: LEGO SPIKE Prime (runloop / motor_pair)
# Left motor: port.${mL}  Right motor: port.${mR}
# Wheel âŒ€: ${diameter} mm  Radius: ${r} mm
# ${'â•'.repeat(50)}

import runloop, math, motor_pair, time
from hub import port

# â”€â”€ Robot parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
r         = ${r}    # wheel radius (mm)
velocity  = 500     # default speed (motor degrees/s)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speed(pct):
    global velocity
    velocity = int(pct * 110)

async def drive(inches):
    mm  = inches * 25.4
    deg = int((mm / (2 * r * math.pi)) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 0, velocity=velocity)

async def turn(degrees):
    deg = int((degrees / 360) * 360)
    await motor_pair.move_for_degrees(
        motor_pair.PAIR_1, deg, 100)

def wait(ms):
    time.sleep_ms(ms)

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    motor_pair.pair(motor_pair.PAIR_1, port.${mL}, port.${mR})
${body.join('\n')}
runloop.run(main())`;
}

// Python syntax colouring
function colourPy(src) {
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return src.split('\n').map(line => {
    let s = esc(line);
    s = s.replace(/(#[^<]*)$/, '<span style="color:#4a7a9a;font-style:italic">$1</span>');
    s = s.replace(/\b(import|from|async|await|def|if|for|in|range|pass|return|global|int)\b/g,
      '<span style="color:#c792ea;font-weight:700">$1</span>');
    s = s.replace(/\b(True|False|None)\b/g, '<span style="color:#ffcb6b">$1</span>');
    s = s.replace(/\b(runloop|motor_pair|math|time|port|PAIR_1)\b/g,
      '<span style="color:#82aaff">$1</span>');
    s = s.replace(/\b(speed|drive|turn|wait|main)\b(?=\s*\()/g,
      '<span style="color:#00e882;font-weight:700">$1</span>');
    s = s.replace(/(-?\b\d+\.?\d*\b)/g, '<span style="color:#ff9d3b">$1</span>');
    return s;
  }).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUN â€” unified: save + parse + field + animate + python
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScript() {
  if (!monacoEditor) return;

  // 1 â€” Save
  if (activeId && files[activeId]) {
    files[activeId].content = monacoEditor.getValue();
    files[activeId].ts      = Date.now();
    saveFiles();
    document.getElementById('unsaved-dot').classList.add('hidden');
  }

  const src = monacoEditor.getValue();
  const { ast, errors } = parse(src);
  const ec = errors.filter(e => e.sev === 'error').length;
  const wc = errors.filter(e => e.sev === 'warning').length;

  // 2 â€” Monaco markers
  const model = monacoEditor.getModel();
  monaco.editor.setModelMarkers(model, 'aw', errors.map(e => ({
    severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
    startLineNumber: e.ln, startColumn: e.c  || 1,
    endLineNumber:   e.ln, endColumn:   e.ec || 200,
    message: e.msg, source: 'AlliedWork'
  })));

  // 3 â€” Badge
  const badge = document.getElementById('err-badge');
  if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';           badge.style.color = 'var(--green)';  }
  else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;   badge.style.color = 'var(--red)';    }
  else                 { badge.textContent = `âš  ${wc} warning${wc>1?'s':''}`; badge.style.color = 'var(--orange)'; }

  // 4 â€” Sidebar stats
  document.getElementById('stat-err').textContent  = ec + wc;
  document.getElementById('stat-err').style.color  = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';

  // 5 â€” Problems panel
  document.getElementById('prob-count').textContent =
    errors.length ? `${errors.length} issue${errors.length > 1 ? 's' : ''}` : '0 issues';
  const pp = document.getElementById('panel-problems');
  pp.innerHTML = errors.length
    ? errors.map(e =>
        `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
          onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
          onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1});switchTab('problems')">
          <span class="cline-ts">Ln ${e.ln}</span>
          <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
          <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
        </div>`).join('')
    : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems found.</span></div>';

  // 6 â€” Field points
  pts = toPoints(ast);
  const L = totalLen();
  document.getElementById('field-stats').textContent =
    pts.length > 1 ? `${pts.length} pts Â· ${L.toFixed(1)}" total` : 'Add move() commands';
  document.getElementById('stat-pts').textContent  = pts.length > 1 ? pts.length : 'â€”';
  document.getElementById('stat-dist').textContent = pts.length > 1 ? L.toFixed(1) + '"' : 'â€”';

  // 7 â€” Python output
  const py = genPython(ast);
  document.getElementById('panel-python').innerHTML = colourPy(py);

  // 8 â€” Console
  switchTab('console');
  log('info', `Run Â· "${files[activeId]?.name||'mission.aw'}" Â· L:${cfg.motorL} R:${cfg.motorR} âŒ€${cfg.diameter}mm`);
  if      (ec) log('err',  `${ec} error${ec>1?'s':''} â€” see Problems tab`);
  else if (wc) log('warn', `${wc} warning${wc>1?'s':''} â€” code generated`);
  else         log('ok',   `Compiled Â· ${ast.missions.length} mission${ast.missions.length!==1?'s':''} Â· ${L.toFixed(1)}" Â· saved`);
  if (!ec) log('py', 'Python ready â€” switch to Python tab or Export .py');

  // 9 â€” Render + animate
  render();
  if (!ec && pts.length >= 2) animateOnce();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPython() {
  if (!monacoEditor) return;
  const { ast } = parse(monacoEditor.getValue());
  const py   = genPython(ast);
  const name = (files[activeId]?.name || 'mission').replace(/\.aw$/, '') + '.py';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([py], { type:'text/x-python' }));
  a.download = name; a.click();
  log('ok', `Exported ${name}`);
}

function copyPython() {
  const text = document.getElementById('panel-python').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied'; btn.style.color = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(() => {
  const handle = document.getElementById('resize-handle');
  const edCol  = document.getElementById('editor-col');
  let active = false;
  handle.addEventListener('mousedown', () => {
    active = true;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!active) return;
    const sbW = sidebarOpen ? 188 : 0;
    const pct = (e.clientX - sbW) / (window.innerWidth - sbW) * 100;
    edCol.style.width = Math.min(Math.max(pct, 20), 65) + '%';
    monacoEditor?.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!active) return;
    active = false;
    document.body.style.cursor = document.body.style.userSelect = '';
    recalcField();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONACO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
require.config({ paths:{ vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], () => {

  monaco.languages.register({ id:'alliedwork' });

  monaco.languages.setMonarchTokensProvider('alliedwork', {
    tokenizer: { root: [
      [/#.*$/, 'comment'],
      [/"[^"]*"/, 'string'],
      [/\b(mission|end|repeat|times)\b/, 'keyword'],
      [/\b(move|turn|speed|wait)\b/, 'fn'],
      [/-?\d+(\.\d+)?/, 'number'],
      [/[().,]/, 'delim'],
    ]}
  });

  const mkTheme = dark => ({
    base: dark ? 'vs-dark' : 'vs', inherit: true,
    rules: [
      { token:'comment',  foreground: dark ? '4a6a8a' : '6a8aaa', fontStyle:'italic' },
      { token:'string',   foreground: dark ? '8bcfb0' : '1a6a40' },
      { token:'keyword',  foreground: dark ? 'c792ea' : '7000c0', fontStyle:'bold' },
      { token:'fn',       foreground: dark ? '00c56e' : '006a38', fontStyle:'bold' },
      { token:'number',   foreground: dark ? 'ff9d3b' : 'b05000' },
      { token:'delim',    foreground: dark ? '5888aa' : '3a6080' },
    ],
    colors: {
      'editor.background':                dark ? '#070e1c' : '#ffffff',
      'editor.foreground':                dark ? '#ccd8f0' : '#0c1c34',
      'editorLineNumber.foreground':      dark ? '#1e3a5f' : '#9ab4d4',
      'editorLineNumber.activeForeground':dark ? '#4a6888' : '#3a5878',
      'editor.lineHighlightBackground':   dark ? '#0a192988' : '#e8f0f888',
      'editorCursor.foreground':          dark ? '#00e882'  : '#006a38',
      'editor.selectionBackground':       dark ? '#003d2255' : '#c0e8d088',
      'editorGutter.background':          dark ? '#070e1c'  : '#f5f9ff',
      'editorError.foreground':           dark ? '#ff3355'  : '#cc0022',
      'editorWarning.foreground':         dark ? '#ff9d3b'  : '#b85000',
      'editorHoverWidget.background':     dark ? '#0a1929'  : '#eef2fa',
      'editorHoverWidget.border':         dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.background':   dark ? '#0a1929'  : '#ffffff',
      'editorSuggestWidget.border':       dark ? '#1e3a5f'  : '#c4d4ec',
      'editorSuggestWidget.selectedBackground': dark ? '#0d1e36' : '#dde8f8',
    }
  });

  monaco.editor.defineTheme('aw-dark',  mkTheme(true));
  monaco.editor.defineTheme('aw-light', mkTheme(false));

  monaco.languages.registerCompletionItemProvider('alliedwork', {
    provideCompletionItems: (model, pos) => {
      const range = {
        startLineNumber:pos.lineNumber, endLineNumber:pos.lineNumber,
        startColumn:1, endColumn:pos.column
      };
      return { suggestions: [
        { label:'move()',    kind:2, insertText:'move(${1:12})',   insertTextRules:4, detail:'Move Â± inches',         range },
        { label:'turn()',    kind:2, insertText:'turn(${1:90})',   insertTextRules:4, detail:'Rotate Â± degrees',       range },
        { label:'speed()',   kind:2, insertText:'speed(${1:80})',  insertTextRules:4, detail:'Set speed 1â€“100%',       range },
        { label:'wait()',    kind:2, insertText:'wait(${1:1.0})',  insertTextRules:4, detail:'Pause N seconds',        range },
        { label:'mission',   kind:14,insertText:'mission "${1:name}"\n\t$0\nend', insertTextRules:4, detail:'Mission block', range },
        { label:'repeat',    kind:14,insertText:'repeat ${1:3} times\n\t$0\nend', insertTextRules:4, detail:'Loop N times',  range },
        { label:'end',       kind:14,insertText:'end', detail:'Close block', range },
      ]};
    }
  });

  monaco.languages.registerHoverProvider('alliedwork', {
    provideHover: (model, pos) => {
      const w = model.getWordAtPosition(pos); if (!w) return null;
      const docs = {
        move:    { sig:'move(inches)',    doc:'Move the robot forward (positive) or backward (negative) by the given number of **inches**.' },
        turn:    { sig:'turn(degrees)',   doc:'Rotate left (+) or right (âˆ’) by the given number of **degrees**.' },
        speed:   { sig:'speed(1â€“100)',    doc:'Set the drive speed as a **percentage** (1â€“100).' },
        wait:    { sig:'wait(seconds)',   doc:'Pause for the given number of **seconds**.' },
        mission: { sig:'mission "name" â€¦ end', doc:'Defines a named mission block, compiled to a Python `async def`.' },
        repeat:  { sig:'repeat N times â€¦ end', doc:'Repeat the inner block **N** times.' },
        end:     { sig:'end',             doc:'Closes a `mission` or `repeat` block.' },
      };
      const info = docs[w.word.toLowerCase()]; if (!info) return null;
      return {
        range: new monaco.Range(pos.lineNumber, w.startColumn, pos.lineNumber, w.endColumn),
        contents: [{ value:'```\n' + info.sig + '\n```' }, { value: info.doc }]
      };
    }
  });

  monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
    value:          '',
    language:       'alliedwork',
    theme:          isDark ? 'aw-dark' : 'aw-light',
    fontSize:       13,
    fontFamily:     '"Space Mono", "Cascadia Code", "Fira Code", monospace',
    lineHeight:     22,
    minimap:        { enabled:false },
    scrollBeyondLastLine: false,
    renderLineHighlight:  'line',
    cursorBlinking:       'smooth',
    cursorSmoothCaretAnimation: 'on',
    smoothScrolling:  true,
    folding:          true,
    tabSize:          2,
    insertSpaces:     true,
    automaticLayout:  true,
    padding:          { top:8, bottom:8 },
    suggest:          { showKeywords:true, showFunctions:true, showSnippets:true },
    scrollbar:        { verticalScrollbarSize:4, horizontalScrollbarSize:4 },
  });

  monacoEditor.onDidChangeCursorPosition(e =>
    document.getElementById('cursor-pos').textContent =
      `Ln ${e.position.lineNumber}, Col ${e.position.column}`
  );

  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runScript);
  monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
    if (activeId && files[activeId]) {
      files[activeId].content = monacoEditor.getValue();
      saveFiles();
      document.getElementById('unsaved-dot').classList.add('hidden');
      log('ok', 'Saved.');
    }
  });

  // Live error markers (debounced, no field redraw)
  let debTimer;
  monacoEditor.onDidChangeModelContent(() => {
    if (skipSave) return;
    document.getElementById('unsaved-dot').classList.remove('hidden');

    // Auto-save debounce
    clearTimeout(window._as);
    window._as = setTimeout(() => {
      if (activeId && files[activeId]) {
        files[activeId].content = monacoEditor.getValue();
        saveFiles();
        document.getElementById('unsaved-dot').classList.add('hidden');
      }
    }, 1400);

    // Live markers debounce
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      const { errors } = parse(monacoEditor.getValue());
      monaco.editor.setModelMarkers(monacoEditor.getModel(), 'aw', errors.map(e => ({
        severity:        e.sev === 'error' ? monaco.MarkerSeverity.Error : monaco.MarkerSeverity.Warning,
        startLineNumber: e.ln, startColumn: e.c  || 1,
        endLineNumber:   e.ln, endColumn:   e.ec || 200,
        message: e.msg, source: 'AlliedWork'
      })));
      const ec = errors.filter(e => e.sev === 'error').length;
      const wc = errors.filter(e => e.sev === 'warning').length;
      const badge = document.getElementById('err-badge');
      if      (!ec && !wc) { badge.textContent = 'âœ“ No errors';                  badge.style.color = 'var(--green)';  }
      else if (ec)         { badge.textContent = `âœ• ${ec} error${ec>1?'s':''}`;  badge.style.color = 'var(--red)';    }
      else                 { badge.textContent = `âš  ${wc} warn${wc>1?'s':''}`;   badge.style.color = 'var(--orange)'; }
      document.getElementById('prob-count').textContent =
        errors.length ? `${errors.length} issue${errors.length>1?'s':''}` : '0 issues';
      document.getElementById('stat-err').textContent = ec + wc;
      document.getElementById('stat-err').style.color = ec ? 'var(--red)' : wc ? 'var(--orange)' : 'var(--green)';
      const pp = document.getElementById('panel-problems');
      pp.innerHTML = errors.length
        ? errors.map(e =>
            `<div class="cline" style="padding:2px 4px;cursor:pointer;border-radius:4px"
              onmouseover="this.style.background='var(--bg4)'" onmouseout="this.style.background=''"
              onclick="monacoEditor.revealLineInCenter(${e.ln});monacoEditor.setPosition({lineNumber:${e.ln},column:1})">
              <span class="cline-ts">Ln ${e.ln}</span>
              <span class="cline-ic ${e.sev==='error'?'c-err':'c-warn'}">${e.sev==='error'?'âœ•':'âš '}</span>
              <span class="${e.sev==='error'?'c-err':'c-warn'}">${e.msg}</span>
            </div>`).join('')
        : '<div class="cline"><span class="cline-ic c-ok">âœ“</span><span class="c-ok">No problems.</span></div>';
    }, 360);
  });

  // â”€â”€ Boot sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const savedActive = localStorage.getItem(LS.active);
  const bootId = (savedActive && files[savedActive]) ? savedActive : Object.keys(files)[0];
  activeId = bootId;
  skipSave = true;
  monacoEditor.setValue(files[bootId]?.content || '');
  skipSave = false;
  document.getElementById('active-tab-name').textContent = files[bootId]?.name || 'mission.aw';
  renderFileList();
  recalcField();

  setTimeout(() => {
    log('sys', 'AlliedWork Â· Allied Algorithms #58590');
    log('info', `Config â€” L:port.${cfg.motorL}  R:port.${cfg.motorR}  âŒ€${cfg.diameter}mm  track:${cfg.track}mm`);
    log('sys', 'Ctrl+Enter to run. Enter in config bar to apply changes.');
    runScript();
  }, 280);
});

// â”€â”€ Kick off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initTheme();
initSidebar();
initFiles();
initCfg();
</script>
</body>
</html>